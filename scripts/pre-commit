#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # sem cor

# PHP-CS-Fixer - Verificar se h√° c√≥digo fora do padr√£o
printf "\n${YELLOW}PHP-CS-Fixer - Verificando formata√ß√£o...${NC}\n"
php vendor/bin/php-cs-fixer fix --dry-run --diff
if [ $? -ne 0 ]; then
  printf "\n${RED}‚ùå PHP-CS-Fixer encontrou arquivos que precisam ser formatados. Commit bloqueado.${NC}\n"
  printf "${YELLOW}üí° Rode: composer cs-fixer${NC}\n"
  exit 1
fi
printf "\n${GREEN}‚úÖ C√≥digo formatado corretamente.${NC}\n"

# PHPStan - An√°lise est√°tica
printf "\n${YELLOW}PHPStan - Analisando c√≥digo...${NC}\n"
php vendor/bin/phpstan analyse --memory-limit=512M --level=9
if [ $? -ne 0 ]; then
  printf "\n${RED}‚ùå PHPStan encontrou erros. Commit bloqueado.${NC}\n"
  exit 1
fi
printf "\n${GREEN}‚úÖ PHPStan passou!${NC}\n"

# Codeception - Testes API, Unit√°rio, Funcional
printf "\n${YELLOW}Executando testes PHPUnit...${NC}\n"
php vendor/bin/phpunit
if [ $? -ne 0 ]; then
  printf "\n${RED}‚ùå Testes falharam. Commit bloqueado.${NC}\n"
  exit 1
fi
printf "\n${GREEN}‚úÖ Testes passaram. Commit liberado.${NC}\n"

exit 0